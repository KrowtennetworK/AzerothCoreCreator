name: Discord Notify

on:
  push:
  pull_request:
    types: [opened, reopened, closed, synchronize]
  issues:
    types: [opened, reopened, closed]
  release:
    types: [published]
  watch:
    types: [started] # ‚≠ê Stars (GitHub uses "watch" for stars)

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send notification to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -e

          EVENT="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          REF="${{ github.ref_name }}"

          # Build a message that is NEVER empty
          MSG="üì¢ GitHub event: **$EVENT** by **$ACTOR**\n$REPO_URL"

          if [ "$EVENT" = "push" ]; then
            COUNT=$(jq -r '.commits | length' "$GITHUB_EVENT_PATH" 2>/dev/null || echo "0")
            COMMIT_MSG=$(jq -r '.head_commit.message // ""' "$GITHUB_EVENT_PATH" 2>/dev/null | head -c 180)
            COMMIT_URL=$(jq -r '.head_commit.url // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            [ -z "$COMMIT_MSG" ] && COMMIT_MSG="(no commit message)"
            [ -z "$COMMIT_URL" ] && COMMIT_URL="$REPO_URL/commits/$REF"
            MSG="‚úÖ **Push** to \`$REF\`\n**$ACTOR** pushed **$COUNT** commit(s)\n> $COMMIT_MSG\n$COMMIT_URL"

          elif [ "$EVENT" = "pull_request" ]; then
            ACTION=$(jq -r '.action // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            PR_NUM=$(jq -r '.pull_request.number // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            PR_TITLE=$(jq -r '.pull_request.title // ""' "$GITHUB_EVENT_PATH" 2>/dev/null | head -c 180)
            PR_URL=$(jq -r '.pull_request.html_url // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            MERGED=$(jq -r '.pull_request.merged // false' "$GITHUB_EVENT_PATH" 2>/dev/null)

            if [ "$ACTION" = "closed" ] && [ "$MERGED" = "true" ]; then
              ACTION="merged"
            fi

            [ -z "$PR_TITLE" ] && PR_TITLE="(no title)"
            [ -z "$PR_URL" ] && PR_URL="$REPO_URL/pulls"
            MSG="üîÄ **PR $ACTION** #$PR_NUM\n**$ACTOR:** $PR_TITLE\n$PR_URL"

          elif [ "$EVENT" = "issues" ]; then
            ACTION=$(jq -r '.action // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            ISSUE_NUM=$(jq -r '.issue.number // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            ISSUE_TITLE=$(jq -r '.issue.title // ""' "$GITHUB_EVENT_PATH" 2>/dev/null | head -c 180)
            ISSUE_URL=$(jq -r '.issue.html_url // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)

            [ -z "$ISSUE_TITLE" ] && ISSUE_TITLE="(no title)"
            [ -z "$ISSUE_URL" ] && ISSUE_URL="$REPO_URL/issues"
            MSG="üêõ **Issue $ACTION** #$ISSUE_NUM\n**$ACTOR:** $ISSUE_TITLE\n$ISSUE_URL"

          elif [ "$EVENT" = "release" ]; then
            NAME=$(jq -r '.release.name // ""' "$GITHUB_EVENT_PATH" 2>/dev/null | head -c 180)
            TAG=$(jq -r '.release.tag_name // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            URL=$(jq -r '.release.html_url // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)

            [ -z "$NAME" ] && NAME="New Release"
            [ -z "$TAG" ] && TAG="(no tag)"
            [ -z "$URL" ] && URL="$REPO_URL/releases"
            MSG="üöÄ **Release published:** $NAME ($TAG)\n$URL"

          elif [ "$EVENT" = "watch" ]; then
            # watch:started == someone starred the repo
            MSG="‚≠ê **$ACTOR starred $REPO!**\n$REPO_URL"
          fi

          # Absolute safety net (Discord rejects empty content)
          if [ -z "$MSG" ]; then
            MSG="(empty notification prevented) Event: $EVENT"
          fi

          PAYLOAD=$(jq -n --arg content "$MSG" '{content:$content}')
          curl -sS -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK_URL"
