name: Discord Notify (Embeds)

on:
  push:
  pull_request:
    types: [opened, reopened, closed, synchronize]
  issues:
    types: [opened, reopened, closed]
  release:
    types: [published]
  watch:
    types: [started] # â­ Stars (GitHub uses "watch" for stars)

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send embed notification to Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -e

          EVENT="${{ github.event_name }}"
          ACTOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"
          REF="${{ github.ref_name }}"
          AVATAR="https://github.com/${ACTOR}.png"

          # Green embed border (Discord embed color is an integer)
          COLOR=5763719  # bright-ish green

          TITLE="GitHub update"
          URL="$REPO_URL"
          DESC="Event: $EVENT"

          if [ "$EVENT" = "push" ]; then
            COUNT=$(jq -r '.commits | length' "$GITHUB_EVENT_PATH" 2>/dev/null || echo "0")
            COMMIT_MSG=$(jq -r '.head_commit.message // ""' "$GITHUB_EVENT_PATH" 2>/dev/null | head -c 180)
            COMMIT_URL=$(jq -r '.head_commit.url // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)

            [ -z "$COMMIT_MSG" ] && COMMIT_MSG="(no commit message)"
            [ -z "$COMMIT_URL" ] && COMMIT_URL="$REPO_URL/commits/$REF"

            TITLE="Push to ${REF}"
            URL="$COMMIT_URL"
            DESC="**${ACTOR}** pushed **${COUNT}** commit(s)\n> ${COMMIT_MSG}"

          elif [ "$EVENT" = "pull_request" ]; then
            ACTION=$(jq -r '.action // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            PR_NUM=$(jq -r '.pull_request.number // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            PR_TITLE=$(jq -r '.pull_request.title // ""' "$GITHUB_EVENT_PATH" 2>/dev/null | head -c 180)
            PR_URL=$(jq -r '.pull_request.html_url // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            MERGED=$(jq -r '.pull_request.merged // false' "$GITHUB_EVENT_PATH" 2>/dev/null)

            if [ "$ACTION" = "closed" ] && [ "$MERGED" = "true" ]; then
              ACTION="merged"
            fi

            [ -z "$PR_TITLE" ] && PR_TITLE="(no title)"
            [ -z "$PR_URL" ] && PR_URL="$REPO_URL/pulls"

            TITLE="PR ${ACTION} #${PR_NUM}"
            URL="$PR_URL"
            DESC="**${ACTOR}**: ${PR_TITLE}"

          elif [ "$EVENT" = "issues" ]; then
            ACTION=$(jq -r '.action // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            ISSUE_NUM=$(jq -r '.issue.number // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            ISSUE_TITLE=$(jq -r '.issue.title // ""' "$GITHUB_EVENT_PATH" 2>/dev/null | head -c 180)
            ISSUE_URL=$(jq -r '.issue.html_url // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)

            [ -z "$ISSUE_TITLE" ] && ISSUE_TITLE="(no title)"
            [ -z "$ISSUE_URL" ] && ISSUE_URL="$REPO_URL/issues"

            TITLE="Issue ${ACTION} #${ISSUE_NUM}"
            URL="$ISSUE_URL"
            DESC="**${ACTOR}**: ${ISSUE_TITLE}"

          elif [ "$EVENT" = "release" ]; then
            NAME=$(jq -r '.release.name // ""' "$GITHUB_EVENT_PATH" 2>/dev/null | head -c 180)
            TAG=$(jq -r '.release.tag_name // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)
            REL_URL=$(jq -r '.release.html_url // ""' "$GITHUB_EVENT_PATH" 2>/dev/null)

            [ -z "$NAME" ] && NAME="New Release"
            [ -z "$TAG" ] && TAG="(no tag)"
            [ -z "$REL_URL" ] && REL_URL="$REPO_URL/releases"

            TITLE="Release published"
            URL="$REL_URL"
            DESC="**${NAME}** (${TAG})"

          elif [ "$EVENT" = "watch" ]; then
            TITLE="Starred"
            URL="$REPO_URL"
            DESC="**${ACTOR}** starred **${REPO}**"
          fi

          [ -z "$DESC" ] && DESC="(empty description prevented)"

          # Timestamp (Discord will show "Today at ..." like the GitHub bot cards)
          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          PAYLOAD=$(jq -n \
            --arg username "GitHub" \
            --arg avatar_url "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg title "$TITLE" \
            --arg url "$URL" \
            --arg description "$DESC" \
            --arg actor "$ACTOR" \
            --arg actor_url "https://github.com/$ACTOR" \
            --arg actor_icon "$AVATAR" \
            --arg repo "$REPO" \
            --arg ref "$REF" \
            --arg ts "$TS" \
            --argjson color "$COLOR" \
            '{
              "username": $username,
              "avatar_url": $avatar_url,
              "embeds": [
                {
                  "color": $color,
                  "author": { "name": $actor, "url": $actor_url, "icon_url": $actor_icon },
                  "title": $title,
                  "url": $url,
                  "description": $description,
                  "footer": { "text": $repo },
                  "timestamp": $ts,
                  "fields": [
                    { "name": "Branch", "value": ("`" + $ref + "`"), "inline": true }
                  ]
                }
              ]
            }')

          curl -sS -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK_URL"
