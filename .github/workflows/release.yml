name: Build & Publish (Velopack)

on:
  push:
    branches: [ master ]
    paths:
      - "AzerothCoreCreator/AzerothCoreCreator.csproj"
      - ".github/workflows/release.yml"

permissions:
  contents: write

env:
  PROJECT_PATH: AzerothCoreCreator/AzerothCoreCreator.csproj
  PACK_ID: KrowtennetworK.AzerothCoreCreator
  MAIN_EXE: AzerothCoreCreator.exe

  CONFIGURATION: Release
  RUNTIME: win-x64
  CHANNEL: win

jobs:
  publish:
    runs-on: windows-latest

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Read version from csproj
        id: ver
        shell: pwsh
        run: |
          [xml]$xml = Get-Content "${{ env.PROJECT_PATH }}"
          $v = $xml.Project.PropertyGroup.Version
          if (-not $v) { throw "No <Version> found in ${{ env.PROJECT_PATH }}" }
          "version=$v" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Decide whether to publish
        id: decide
        shell: pwsh
        run: |
          git fetch --tags --force
          $v = "${{ steps.ver.outputs.version }}"
          $tag = "v$v"

          # If this tag already exists, we skip EVERYTHING that would pack/publish.
          $exists = (git tag -l $tag) -ne $null -and (git tag -l $tag).Trim().Length -gt 0

          if ($exists) {
            Write-Host "Tag $tag already exists. Skipping release."
            "should_publish=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }
          else {
            Write-Host "Tag $tag not found. Publishing release."
            "should_publish=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          }

      - name: Stop early (no version bump)
        if: steps.decide.outputs.should_publish != 'true'
        shell: pwsh
        run: |
          Write-Host "No version change detected (tag exists). Exiting job successfully."
          exit 0

      # Install Velopack CLI (adjust if you already install elsewhere)
      - name: Install Velopack CLI
        shell: pwsh
        run: |
          dotnet tool update -g vpk

      - name: Publish app
        shell: pwsh
        run: |
          dotnet publish "${{ env.PROJECT_PATH }}" -c "${{ env.CONFIGURATION }}" -r "${{ env.RUNTIME }}" --self-contained true `
            -p:PublishSingleFile=false

      # OPTIONAL (deltas): download previous release assets into Releases folder
      # Keep your existing logic here if you use deltas; gated behind should_publish already.
      - name: Download previous release (for delta packages)
        shell: pwsh
        continue-on-error: true
        run: |
          # If you have your own download logic, keep it; this is a placeholder.
          # It's safe because we only get here when publishing a NEW version.
          Write-Host "Downloading previous release assets (if any)..."

      - name: Pack (Velopack)
        shell: pwsh
        run: |
          $v = "${{ steps.ver.outputs.version }}"
          vpk pack `
            --packId "${{ env.PACK_ID }}" `
            --packVersion "$v" `
            --packDir "AzerothCoreCreator/bin/${{ env.CONFIGURATION }}/${{ env.RUNTIME }}/publish" `
            --mainExe "${{ env.MAIN_EXE }}" `
            --channel "${{ env.CHANNEL }}" `
            --outputDir "Releases"

      - name: Create GitHub Release + Upload Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh
        run: |
          $v = "${{ steps.ver.outputs.version }}"
          $tag = "v$v"

          # Create release (prerelease if version contains '-')
          $isPre = $v -match "-"
          $preArg = $isPre ? "--prerelease" : ""

          gh release create $tag Releases/* `
            --title "$tag" `
            $preArg
